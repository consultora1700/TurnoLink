// ===========================================
// TURNERO SAAS - Database Schema
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USERS ============

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  password      String
  name          String
  role          String   @default("OWNER")
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false) // Email verificado
  tenantId      String?
  tenant        Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Security Relations
  totpSecret         TotpSecret?
  emailVerifications EmailVerification[]
  passwordResets     PasswordReset[]

  @@index([email])
  @@index([tenantId])
  @@map("users")
}

// ============ TENANTS (BUSINESSES) ============

model Tenant {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  type        String   @default("BUSINESS")
  description String?
  logo        String?
  coverImage  String?
  phone       String?
  email       String?
  address     String?
  city        String?
  instagram   String?
  facebook    String?
  website     String?
  settings    String   @default("{}")
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Turnero Relations
  users         User[]
  employees     Employee[]
  services      Service[]
  categories    ServiceCategory[]
  schedules     Schedule[]
  blockedDates  BlockedDate[]
  bookings      Booking[]
  customers     Customer[]
  media         Media[]
  notifications Notification[]
  branches      Branch[]

  // E-Commerce Relations
  branding             TenantBranding?
  productCategories    ProductCategory[]
  products             Product[]
  carts                Cart[]
  orders               Order[]
  coupons              Coupon[]
  mercadoPagoCredential MercadoPagoCredential?
  depositPayments      DepositPayment[]

  // Subscription & Reviews Relations
  subscription         Subscription?
  reviews              Review[]

  // Push Notifications
  pushSubscriptions    PushSubscription[]

  // Talent Proposals
  talentProposals      TalentProposal[]

  @@index([slug])
  @@index([status])
  @@map("tenants")
}

// ============ BRANCHES (SUCURSALES) ============

model Branch {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  slug      String
  image     String?  // Branch photo URL
  address   String?
  city      String?
  phone     String?
  email     String?
  isMain    Boolean  @default(false)
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  schedules        BranchSchedule[]
  blockedDates     BranchBlockedDate[]
  branchServices   BranchService[]
  branchEmployees  BranchEmployee[]
  bookings         Booking[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([isActive])
  @@index([tenantId, isActive])
  @@map("branches")
}

model BranchSchedule {
  id        String   @id @default(uuid())
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  dayOfWeek Int
  startTime String
  endTime   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([branchId, dayOfWeek])
  @@index([branchId])
  @@map("branch_schedules")
}

model BranchBlockedDate {
  id        String   @id @default(uuid())
  branchId  String
  branch    Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  date      DateTime
  reason    String?
  createdAt DateTime @default(now())

  @@unique([branchId, date])
  @@index([branchId])
  @@index([date])
  @@map("branch_blocked_dates")
}

model BranchService {
  id            String   @id @default(uuid())
  branchId      String
  branch        Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  serviceId     String
  service       Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  priceOverride Decimal? @db.Decimal(10, 2) // Precio diferente por sucursal
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([branchId, serviceId])
  @@index([branchId])
  @@index([serviceId])
  @@map("branch_services")
}

model BranchEmployee {
  id         String   @id @default(uuid())
  branchId   String
  branch     Branch   @relation(fields: [branchId], references: [id], onDelete: Cascade)
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([branchId, employeeId])
  @@index([branchId])
  @@index([employeeId])
  @@map("branch_employees")
}

model EmployeeService {
  id         String   @id @default(uuid())
  employeeId String
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  serviceId  String
  service    Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([employeeId, serviceId])
  @@index([employeeId])
  @@index([serviceId])
  @@map("employee_services")
}

// ============ EMPLOYEES ============

model Employee {
  id        String    @id @default(uuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  email     String?
  phone     String?
  image     String?
  specialty String?   // Ej: "Colorista", "Masajista", etc.
  bio       String?   // Breve descripción
  isActive  Boolean   @default(true)
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt          DateTime? // Soft delete timestamp
  welcomeEmailSentAt DateTime? // Tracks when welcome email was sent

  // Relations
  bookings         Booking[]
  branchEmployees  BranchEmployee[]
  employeeServices EmployeeService[]
  employeeTokens   EmployeeToken[]

  @@index([tenantId])
  @@index([isActive])
  @@index([tenantId, isActive])
  @@index([deletedAt])
  @@map("employees")
}

// ============ EMPLOYEE TOKENS ============

model EmployeeToken {
  id         String    @id @default(uuid())
  employeeId String
  employee   Employee  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  token      String    @unique
  type       String    // "PROFILE_ACCESS"
  expiresAt  DateTime
  usedAt     DateTime?
  createdAt  DateTime  @default(now())

  @@index([employeeId])
  @@index([token])
  @@map("employee_tokens")
}

// ============ PROFESSIONAL PROFILES ============

model ProfessionalProfile {
  id              String    @id @default(uuid())
  employeeId      String?   // For employer-created profiles (null for self-registered)
  userId          String?   // For self-registered PROFESSIONAL users
  email           String    @unique
  phone           String?
  name            String
  image           String?
  specialty       String?
  category        String?   // Predefined category (estetica-belleza, barberia, etc.)
  coverImage      String?   // Cover/banner image URL
  headerTemplate  String?   // Header template override (vibrant, clinical, corporate, modern, minimal)
  bio             String?
  headline        String?
  yearsExperience Int?
  skills          String    @default("[]")
  certifications  String    @default("[]")
  availability    String?
  preferredZones  String    @default("[]")
  consentedAt     DateTime?
  consentIp       String?
  openToWork      Boolean   @default(false)
  profileVisible  Boolean   @default(false)
  lastActiveAt    DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  experiences ProfessionalExperience[]
  proposals   TalentProposal[]

  @@index([employeeId])
  @@index([userId])
  @@index([category])
  @@index([openToWork, profileVisible])
  @@map("professional_profiles")
}

model ProfessionalExperience {
  id           String              @id @default(uuid())
  profileId    String
  profile      ProfessionalProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  businessName String
  role         String
  startDate    DateTime
  endDate      DateTime?
  isCurrent    Boolean             @default(false)
  description  String?
  createdAt    DateTime            @default(now())

  @@index([profileId])
  @@map("professional_experiences")
}

// ============ TALENT PROPOSALS ============

model TalentProposal {
  id              String    @id @default(uuid())
  profileId       String
  profile         ProfessionalProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  senderTenantId  String
  senderTenant    Tenant    @relation(fields: [senderTenantId], references: [id], onDelete: Cascade)

  // Proposal
  role            String
  message         String
  availability    String?

  // Status
  status          String    @default("PENDING") // PENDING, ACCEPTED, REJECTED, EXPIRED
  respondedAt     DateTime?
  responseMessage String?

  // Tracking
  viewedAt        DateTime?

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([profileId])
  @@index([senderTenantId])
  @@index([status])
  @@map("talent_proposals")
}

// ============ SERVICE CATEGORIES ============

model ServiceCategory {
  id        String    @id @default(uuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  order     Int       @default(0)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime? // Soft delete timestamp

  // Relations
  services Service[]

  @@index([tenantId])
  @@index([deletedAt])
  @@map("service_categories")
}

// ============ SERVICES ============

model Service {
  id          String           @id @default(uuid())
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  name        String
  description String?
  includes    String?          // What the service includes (features list)
  price       Decimal          @db.Decimal(10, 2)
  duration    Int
  image       String?
  images           String  @default("[]")
  imageDisplayMode String  @default("cover")
  variations       String  @default("[]")
  isActive         Boolean @default(true)
  order       Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  deletedAt   DateTime?        // Soft delete timestamp

  // Relations
  bookings         Booking[]
  branchServices   BranchService[]
  employeeServices EmployeeService[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([tenantId, isActive])
  @@index([deletedAt])
  @@map("services")
}

// ============ SCHEDULES ============

model Schedule {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dayOfWeek Int
  startTime String
  endTime   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
  @@map("schedules")
}

// ============ BLOCKED DATES ============

model BlockedDate {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date      DateTime
  reason    String?
  createdAt DateTime @default(now())

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
  @@map("blocked_dates")
}

// ============ CUSTOMERS ============

model Customer {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name          String
  phone         String
  email         String?
  notes         String?
  totalBookings Int       @default(0)
  lastBookingAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // Soft delete timestamp

  // Turnero Relations
  bookings      Booking[]
  reviews       Review[]

  // E-Commerce Relations
  carts         Cart[]
  orders        Order[]
  wishlistItems WishlistItem[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
  @@index([deletedAt])
  @@map("customers")
}

// ============ BOOKINGS ============

model Booking {
  id         String    @id @default(uuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  branchId   String?
  branch     Branch?   @relation(fields: [branchId], references: [id], onDelete: SetNull)
  serviceId  String
  service    Service   @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  customerId String
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Restrict)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  date       DateTime
  startTime  String
  endTime    String
  status     String    @default("PENDING")
  notes      String?
  // Daily booking fields (null for hourly bookings)
  checkOutDate     DateTime?            // Check-out date for daily bookings
  totalNights      Int?                 // Number of nights
  totalPrice       Decimal? @db.Decimal(10, 2) // Total price (nights × price per night)
  // Deposit/Seña fields
  depositAmount    Decimal? @db.Decimal(10, 2)
  depositPaid      Boolean  @default(false)
  depositPaidAt    DateTime?
  depositReference String?  // Reference for payment tracking
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  notifications Notification[]

  @@index([tenantId])
  @@index([branchId])
  @@index([serviceId])
  @@index([customerId])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([tenantId, date])
  @@index([tenantId, status, date])
  @@index([tenantId, checkOutDate])
  @@map("bookings")
}

// ============ MEDIA ============

model Media {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  folder       String?
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([folder])
  @@map("media")
}

// ============ NOTIFICATIONS ============

model Notification {
  id        String    @id @default(uuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookingId String
  booking   Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  type      String
  channel   String
  recipient String
  content   String
  status    String    @default("PENDING")
  sentAt    DateTime?
  error     String?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([bookingId])
  @@index([status])
  @@map("notifications")
}

// ===========================================
// E-COMMERCE MODELS
// ===========================================

// ============ TENANT BRANDING ============

model TenantBranding {
  id                 String   @id @default(uuid())
  tenantId           String   @unique
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Colors
  primaryColor       String   @default("#6366f1")
  secondaryColor     String   @default("#8b5cf6")
  accentColor        String   @default("#f59e0b")
  backgroundColor    String   @default("#ffffff")
  textColor          String   @default("#1f2937")

  // Typography
  fontFamily         String   @default("Inter")
  headingFontFamily  String   @default("Inter")

  // Images
  logoUrl            String?
  coverImageUrl      String?
  faviconUrl         String?
  bannerImageUrl     String?

  // Texts
  welcomeTitle       String?
  welcomeSubtitle    String?
  footerText         String?

  // SEO
  metaTitle          String?
  metaDescription    String?

  // Store Config
  showPrices         Boolean  @default(true)
  showStock          Boolean  @default(true)
  enableWishlist     Boolean  @default(true)
  enableReviews      Boolean  @default(false)
  storeEnabled       Boolean  @default(false)

  // Public Page Customization
  backgroundStyle    String   @default("modern") // minimal, modern, elegant, fresh, vibrant

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("tenant_brandings")
}

// ============ PRODUCT CATEGORIES ============

model ProductCategory {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    ProductCategory[] @relation("CategoryHierarchy")
  name        String
  slug        String
  description String?
  image       String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products    Product[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([parentId])
  @@index([isActive])
  @@map("product_categories")
}

// ============ PRODUCTS ============

model Product {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId        String?
  category          ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Basic Info
  name              String
  slug              String
  description       String?
  shortDescription  String?

  // Pricing
  price             Decimal  @db.Decimal(10, 2)
  compareAtPrice    Decimal? @db.Decimal(10, 2)
  costPrice         Decimal? @db.Decimal(10, 2)

  // Inventory
  sku               String?
  stock             Int      @default(0)
  lowStockThreshold Int      @default(5)
  trackInventory    Boolean  @default(true)

  // Type
  type              String   @default("PHYSICAL") // PHYSICAL, DIGITAL, SERVICE
  digitalFileUrl    String?

  // Status
  isActive          Boolean  @default(true)
  isFeatured        Boolean  @default(false)
  order             Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  images            ProductImage[]
  variants          ProductVariant[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  wishlistItems     WishlistItem[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([tenantId, isActive, isFeatured])
  @@map("products")
}

// ============ PRODUCT IMAGES ============

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  order     Int      @default(0)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([productId])
  @@map("product_images")
}

// ============ PRODUCT VARIANTS ============

model ProductVariant {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name       String   // e.g., "Size", "Color"
  value      String   // e.g., "Large", "Red"
  sku        String?
  price      Decimal? @db.Decimal(10, 2) // Override product price
  stock      Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@map("product_variants")
}

// ============ CARTS ============

model Cart {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessionId  String?  // For guest carts
  customerId String?  // For logged-in customers
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  couponId   String?
  coupon     Coupon?  @relation(fields: [couponId], references: [id], onDelete: SetNull)
  expiresAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  items      CartItem[]

  @@unique([tenantId, sessionId])
  @@index([tenantId])
  @@index([customerId])
  @@index([sessionId])
  @@map("carts")
}

// ============ CART ITEMS ============

model CartItem {
  id         String   @id @default(uuid())
  cartId     String
  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  quantity   Int      @default(1)
  price      Decimal  @db.Decimal(10, 2) // Price at time of adding
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// ============ ORDERS ============

model Order {
  id               String   @id @default(uuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderNumber      String   // User-facing order number
  customerId       String?
  customer         Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Customer Snapshot (in case customer deleted)
  customerEmail    String
  customerPhone    String?
  customerName     String

  // Status
  status           String   @default("PENDING") // PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED

  // Totals
  subtotal         Decimal  @db.Decimal(10, 2)
  shippingCost     Decimal  @db.Decimal(10, 2) @default(0)
  discount         Decimal  @db.Decimal(10, 2) @default(0)
  tax              Decimal  @db.Decimal(10, 2) @default(0)
  total            Decimal  @db.Decimal(10, 2)

  // Addresses (JSON strings for SQLite compatibility)
  shippingAddress  String?
  billingAddress   String?

  // Coupon
  couponId         String?
  couponCode       String?

  // Notes
  notes            String?
  internalNotes    String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  items            OrderItem[]
  statusHistory    OrderStatusHistory[]
  payments         Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@index([status, createdAt])
  @@map("orders")
}

// ============ ORDER ITEMS ============

model OrderItem {
  id              String   @id @default(uuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String?
  product         Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variantId       String?
  variant         ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  // Snapshot (in case product deleted)
  productName     String
  variantName     String?
  sku             String?

  quantity        Int
  unitPrice       Decimal  @db.Decimal(10, 2)
  totalPrice      Decimal  @db.Decimal(10, 2)

  // For digital products
  downloadUrl     String?
  downloadCount   Int      @default(0)
  maxDownloads    Int      @default(5)

  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============ ORDER STATUS HISTORY ============

model OrderStatusHistory {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status      String
  note        String?
  createdBy   String?  // User ID who changed status
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@map("order_status_history")
}

// ============ PAYMENTS ============

model Payment {
  id                 String    @id @default(uuid())
  orderId            String
  order              Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Mercado Pago fields
  mercadoPagoId      String?   @unique
  externalReference  String?
  preferenceId       String?

  // Payment info
  amount             Decimal   @db.Decimal(10, 2)
  currency           String    @default("ARS")
  status             String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED, REFUNDED
  paymentMethod      String?
  paymentType        String?

  // Payer info
  payerEmail         String?
  payerName          String?

  // Dates
  paidAt             DateTime?
  refundedAt         DateTime?

  // Raw response
  rawResponse        String?   // JSON string

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([orderId])
  @@index([mercadoPagoId])
  @@index([status])
  @@map("payments")
}

// ============ COUPONS ============

model Coupon {
  id               String    @id @default(uuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code             String
  description      String?

  // Discount type
  discountType     String    @default("PERCENTAGE") // PERCENTAGE, FIXED
  discountValue    Decimal   @db.Decimal(10, 2)

  // Limits
  minPurchase      Decimal?  @db.Decimal(10, 2)
  maxDiscount      Decimal?  @db.Decimal(10, 2)
  usageLimit       Int?      // Total uses allowed
  usageCount       Int       @default(0)
  usagePerCustomer Int       @default(1)

  // Validity
  startsAt         DateTime?
  expiresAt        DateTime?
  isActive         Boolean   @default(true)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  carts            Cart[]
  usages           CouponUsage[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

// ============ COUPON USAGE ============

model CouponUsage {
  id         String   @id @default(uuid())
  couponId   String
  coupon     Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  customerId String?
  orderId    String?
  usedAt     DateTime @default(now())

  @@index([couponId])
  @@index([customerId])
  @@map("coupon_usages")
}

// ============ WISHLIST ============

model WishlistItem {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([customerId, productId])
  @@index([tenantId])
  @@index([customerId])
  @@map("wishlist_items")
}

// ===========================================
// SECURITY MODELS
// ===========================================

// ============ TOTP (2FA) ============

model TotpSecret {
  id           String    @id @default(uuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Encrypted secret
  secret       String    // AES-256-GCM encrypted
  iv           String    // Initialization vector

  // Backup codes (hashed)
  backupCodes  String?   // JSON array of hashed codes

  // Status
  isEnabled    Boolean   @default(false)
  isVerified   Boolean   @default(false)

  // Timestamps
  enabledAt    DateTime?
  lastUsedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("totp_secrets")
}

// ============ MERCADO PAGO CREDENTIALS ============

model MercadoPagoCredential {
  id             String    @id @default(uuid())
  tenantId       String    @unique
  tenant         Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // OAuth credentials (AES-256-GCM encrypted)
  accessToken    String    // AES-256-GCM encrypted
  refreshToken   String?   // AES-256-GCM encrypted (for OAuth refresh)
  publicKey      String    // AES-256-GCM encrypted
  userId         String?   // Mercado Pago user ID
  iv             String    // Initialization vector

  // Token management
  expiresAt      DateTime? // Token expiration time

  // Mode
  isSandbox      Boolean   @default(false)

  // Connection status
  isConnected    Boolean   @default(false)
  connectedAt    DateTime?
  disconnectedAt DateTime?

  // Webhook
  webhookSecret  String?

  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("mercadopago_credentials")
}

// ============ DEPOSIT PAYMENTS (for booking deposits) ============

model DepositPayment {
  id                String    @id @default(uuid())
  tenantId          String
  tenant            Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookingId         String    @unique
  preferenceId      String    @unique  // Mercado Pago preference ID
  paymentId         String?   @unique  // Mercado Pago payment ID
  externalReference String    @unique  // Unique reference for tracking

  // Payment info
  amount            Decimal   @db.Decimal(10, 2)
  currency          String    @default("ARS")
  status            String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED, EXPIRED

  // Payer info
  payerEmail        String?
  payerName         String?
  paymentMethod     String?

  // Dates
  paidAt            DateTime?
  expiresAt         DateTime?

  // Raw responses (JSON strings for debugging)
  rawPreference     String?   // JSON of MP preference response
  rawPayment        String?   // JSON of MP payment notification

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([tenantId])
  @@index([bookingId])
  @@index([status])
  @@index([tenantId, status])
  @@map("deposit_payments")
}

// ===========================================
// SUBSCRIPTION MODELS
// ===========================================

// ============ SUBSCRIPTION PLANS ============

model SubscriptionPlan {
  id              String   @id @default(uuid())
  name            String   // "Gratis", "Profesional", "Negocio"
  slug            String   @unique
  description     String?

  // Pricing
  priceMonthly    Decimal  @db.Decimal(10, 2)
  priceYearly     Decimal? @db.Decimal(10, 2) // Precio anual con descuento
  currency        String   @default("ARS")

  // Trial
  trialDays       Int      @default(14)

  // Limits (null = ilimitado)
  maxBranches     Int      @default(1)   // Sucursales permitidas
  maxEmployees    Int      @default(5)   // Empleados permitidos
  maxServices     Int?     // Servicios permitidos, null = ilimitado
  maxBookingsMonth Int?    // null = ilimitado
  maxCustomers    Int?     // Clientes permitidos, null = ilimitado

  // Features (JSON array of feature slugs)
  features        String   @default("[]") // ["whatsapp", "mercadopago", "reports", etc.]

  // Display
  isPopular       Boolean  @default(false)
  isActive        Boolean  @default(true)
  order           Int      @default(0)

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  subscriptions   Subscription[]

  @@map("subscription_plans")
}

// ============ SUBSCRIPTIONS ============

model Subscription {
  id                  String    @id @default(uuid())
  tenantId            String    @unique
  tenant              Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  planId              String
  plan                SubscriptionPlan @relation(fields: [planId], references: [id])

  // Status
  status              String    @default("TRIALING") // TRIALING, ACTIVE, PAST_DUE, CANCELLED, EXPIRED

  // Billing
  billingPeriod       String    @default("MONTHLY") // MONTHLY, YEARLY

  // Dates
  trialStartAt        DateTime?
  trialEndAt          DateTime?
  currentPeriodStart  DateTime?
  currentPeriodEnd    DateTime?
  cancelledAt         DateTime?
  cancelReason        String?

  // Mercado Pago Subscription
  mpSubscriptionId    String?   @unique // Mercado Pago preapproval ID
  mpPayerId           String?   // Mercado Pago payer ID

  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt

  // Relations
  payments            SubscriptionPayment[]

  @@index([tenantId])
  @@index([status])
  @@index([planId])
  @@map("subscriptions")
}

// ============ SUBSCRIPTION PAYMENTS ============

model SubscriptionPayment {
  id                String    @id @default(uuid())
  subscriptionId    String
  subscription      Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  // Mercado Pago
  mpPaymentId       String?   @unique

  // Payment info
  amount            Decimal   @db.Decimal(10, 2)
  currency          String    @default("ARS")
  status            String    @default("PENDING") // PENDING, APPROVED, REJECTED, REFUNDED

  // Period
  periodStart       DateTime?
  periodEnd         DateTime?

  // Dates
  paidAt            DateTime?

  // Raw response
  rawResponse       String?   // JSON

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@index([subscriptionId])
  @@index([status])
  @@map("subscription_payments")
}

// ============ EMAIL VERIFICATION ============

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  verified  Boolean  @default(false)
  verifiedAt DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("email_verifications")
}

// ============ PASSWORD RESET ============

model PasswordReset {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  usedAt    DateTime?
  createdAt DateTime @default(now())

  @@index([userId])
  @@index([token])
  @@map("password_resets")
}

// ============ PLATFORM CONFIG ============

model PlatformConfig {
  id        String   @id @default(uuid())
  key       String   @unique
  value     String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("platform_config")
}

// ============ REVIEWS (REPUTATION) ============

model Review {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customerId  String
  customer    Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  bookingId   String   @unique // Una review por booking

  // Rating
  rating      Int      // 1-5 estrellas
  comment     String?

  // Moderation
  isApproved  Boolean  @default(true)
  isVisible   Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([tenantId])
  @@index([customerId])
  @@index([rating])
  @@index([tenantId, isVisible])
  @@map("reviews")
}

// ===========================================
// ADMIN PANEL MODELS
// ===========================================

// ============ AUDIT LOGS ============

model AuditLog {
  id          String        @id @default(uuid())
  timestamp   DateTime      @default(now())
  action      String        // LOGIN, LOGOUT, CREATE, UPDATE, DELETE, PAYMENT, ADMIN_ACTION, etc.
  entityType  String        // User, Tenant, Subscription, Payment, etc.
  entityId    String?
  userId      String?
  tenantId    String?
  ipAddress   String?
  userAgent   String?
  details     Json?         // Additional context about the action
  severity    AuditSeverity @default(INFO)

  @@index([timestamp])
  @@index([action])
  @@index([userId])
  @@index([tenantId])
  @@index([severity])
  @@index([entityType])
  @@index([timestamp, severity])
  @@map("audit_logs")
}

// ============ SECURITY ALERTS ============

model SecurityAlert {
  id          String        @id @default(uuid())
  createdAt   DateTime      @default(now())
  type        AlertType
  severity    AlertSeverity
  title       String
  description String
  metadata    Json?         // Additional context (IP, userId, etc.)
  resolved    Boolean       @default(false)
  resolvedAt  DateTime?
  resolvedBy  String?       // Admin who resolved the alert

  @@index([createdAt])
  @@index([resolved])
  @@index([severity])
  @@index([type])
  @@index([resolved, severity])
  @@map("security_alerts")
}

// ============ ADMIN SESSIONS ============

model AdminSession {
  id          String    @id @default(uuid())
  sessionToken String   @unique
  ipAddress   String
  userAgent   String?
  createdAt   DateTime  @default(now())
  expiresAt   DateTime
  lastActivityAt DateTime @default(now())
  isActive    Boolean   @default(true)

  @@index([sessionToken])
  @@index([expiresAt])
  @@index([isActive])
  @@map("admin_sessions")
}

// ============ ADMIN RATE LIMITING ============

model AdminRateLimit {
  id          String    @id @default(uuid())
  ipAddress   String
  attempts    Int       @default(0)
  blockedUntil DateTime?
  lastAttemptAt DateTime @default(now())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([ipAddress])
  @@index([ipAddress])
  @@index([blockedUntil])
  @@map("admin_rate_limits")
}

// ============ ENUMS ============

enum AuditSeverity {
  INFO
  WARNING
  CRITICAL
}

enum AlertType {
  MULTIPLE_FAILED_LOGINS
  SUSPICIOUS_ACTIVITY
  PAYMENT_FAILURE
  SUBSCRIPTION_EXPIRED
  HIGH_CHURN
  UNUSUAL_TRAFFIC
  ADMIN_LOGIN_FAILED
  SECURITY_CONFIG_CHANGE
}

enum AlertSeverity {
  LOW
  MEDIUM
  HIGH
  CRITICAL
}

model PushSubscription {
  id        String   @id @default(uuid())
  tenantId  String
  userId    String
  endpoint  String   @unique
  p256dh    String
  auth      String
  createdAt DateTime @default(now())

  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@index([userId])
  @@map("push_subscriptions")
}
