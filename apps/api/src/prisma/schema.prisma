// ===========================================
// TURNERO SAAS - Database Schema
// ===========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============ USERS ============

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      String   @default("OWNER")
  isActive  Boolean  @default(true)
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Security Relations
  totpSecret TotpSecret?

  @@index([email])
  @@index([tenantId])
  @@map("users")
}

// ============ TENANTS (BUSINESSES) ============

model Tenant {
  id          String   @id @default(uuid())
  slug        String   @unique
  name        String
  description String?
  logo        String?
  coverImage  String?
  phone       String?
  email       String?
  address     String?
  city        String?
  instagram   String?
  facebook    String?
  website     String?
  settings    String   @default("{}")
  status      String   @default("ACTIVE")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Turnero Relations
  users         User[]
  employees     Employee[]
  services      Service[]
  categories    ServiceCategory[]
  schedules     Schedule[]
  blockedDates  BlockedDate[]
  bookings      Booking[]
  customers     Customer[]
  media         Media[]
  notifications Notification[]

  // E-Commerce Relations
  branding             TenantBranding?
  productCategories    ProductCategory[]
  products             Product[]
  carts                Cart[]
  orders               Order[]
  coupons              Coupon[]
  mercadoPagoCredential MercadoPagoCredential?

  @@index([slug])
  @@index([status])
  @@map("tenants")
}

// ============ EMPLOYEES ============

model Employee {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  email     String?
  phone     String?
  image     String?
  specialty String?  // Ej: "Colorista", "Masajista", etc.
  bio       String?  // Breve descripción
  isActive  Boolean  @default(true)
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  bookings  Booking[]

  @@index([tenantId])
  @@index([isActive])
  @@map("employees")
}

// ============ SERVICE CATEGORIES ============

model ServiceCategory {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name      String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  services Service[]

  @@index([tenantId])
  @@map("service_categories")
}

// ============ SERVICES ============

model Service {
  id          String           @id @default(uuid())
  tenantId    String
  tenant      Tenant           @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId  String?
  category    ServiceCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  name        String
  description String?
  price       Float
  duration    Int
  image       String?
  isActive    Boolean          @default(true)
  order       Int              @default(0)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relations
  bookings Booking[]

  @@index([tenantId])
  @@index([categoryId])
  @@index([isActive])
  @@map("services")
}

// ============ SCHEDULES ============

model Schedule {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  dayOfWeek Int
  startTime String
  endTime   String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenantId, dayOfWeek])
  @@index([tenantId])
  @@map("schedules")
}

// ============ BLOCKED DATES ============

model BlockedDate {
  id        String   @id @default(uuid())
  tenantId  String
  tenant    Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  date      DateTime
  reason    String?
  createdAt DateTime @default(now())

  @@unique([tenantId, date])
  @@index([tenantId])
  @@index([date])
  @@map("blocked_dates")
}

// ============ CUSTOMERS ============

model Customer {
  id            String    @id @default(uuid())
  tenantId      String
  tenant        Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name          String
  phone         String
  email         String?
  notes         String?
  totalBookings Int       @default(0)
  lastBookingAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Turnero Relations
  bookings      Booking[]

  // E-Commerce Relations
  carts         Cart[]
  orders        Order[]
  wishlistItems WishlistItem[]

  @@unique([tenantId, phone])
  @@index([tenantId])
  @@index([phone])
  @@map("customers")
}

// ============ BOOKINGS ============

model Booking {
  id         String    @id @default(uuid())
  tenantId   String
  tenant     Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  serviceId  String
  service    Service   @relation(fields: [serviceId], references: [id], onDelete: Restrict)
  customerId String
  customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Restrict)
  employeeId String?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)
  date       DateTime
  startTime  String
  endTime    String
  status     String    @default("PENDING")
  notes      String?
  // Deposit/Seña fields
  depositAmount    Float?
  depositPaid      Boolean  @default(false)
  depositPaidAt    DateTime?
  depositReference String?  // Reference for payment tracking
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  notifications Notification[]

  @@index([tenantId])
  @@index([serviceId])
  @@index([customerId])
  @@index([employeeId])
  @@index([date])
  @@index([status])
  @@index([tenantId, date])
  @@map("bookings")
}

// ============ MEDIA ============

model Media {
  id           String   @id @default(uuid())
  tenantId     String
  tenant       Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  filename     String
  originalName String
  mimeType     String
  size         Int
  url          String
  folder       String?
  createdAt    DateTime @default(now())

  @@index([tenantId])
  @@index([folder])
  @@map("media")
}

// ============ NOTIFICATIONS ============

model Notification {
  id        String    @id @default(uuid())
  tenantId  String
  tenant    Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookingId String
  booking   Booking   @relation(fields: [bookingId], references: [id], onDelete: Cascade)
  type      String
  channel   String
  recipient String
  content   String
  status    String    @default("PENDING")
  sentAt    DateTime?
  error     String?
  createdAt DateTime  @default(now())

  @@index([tenantId])
  @@index([bookingId])
  @@index([status])
  @@map("notifications")
}

// ===========================================
// E-COMMERCE MODELS
// ===========================================

// ============ TENANT BRANDING ============

model TenantBranding {
  id                 String   @id @default(uuid())
  tenantId           String   @unique
  tenant             Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Colors
  primaryColor       String   @default("#6366f1")
  secondaryColor     String   @default("#8b5cf6")
  accentColor        String   @default("#f59e0b")
  backgroundColor    String   @default("#ffffff")
  textColor          String   @default("#1f2937")

  // Typography
  fontFamily         String   @default("Inter")
  headingFontFamily  String   @default("Inter")

  // Images
  logoUrl            String?
  coverImageUrl      String?
  faviconUrl         String?
  bannerImageUrl     String?

  // Texts
  welcomeTitle       String?
  welcomeSubtitle    String?
  footerText         String?

  // SEO
  metaTitle          String?
  metaDescription    String?

  // Store Config
  showPrices         Boolean  @default(true)
  showStock          Boolean  @default(true)
  enableWishlist     Boolean  @default(true)
  enableReviews      Boolean  @default(false)
  storeEnabled       Boolean  @default(false)

  // Public Page Customization
  backgroundStyle    String   @default("modern") // minimal, modern, elegant, fresh, vibrant

  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@map("tenant_brandings")
}

// ============ PRODUCT CATEGORIES ============

model ProductCategory {
  id          String   @id @default(uuid())
  tenantId    String
  tenant      Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  parentId    String?
  parent      ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id], onDelete: SetNull)
  children    ProductCategory[] @relation("CategoryHierarchy")
  name        String
  slug        String
  description String?
  image       String?
  isActive    Boolean  @default(true)
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  products    Product[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([parentId])
  @@index([isActive])
  @@map("product_categories")
}

// ============ PRODUCTS ============

model Product {
  id                String   @id @default(uuid())
  tenantId          String
  tenant            Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  categoryId        String?
  category          ProductCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  // Basic Info
  name              String
  slug              String
  description       String?
  shortDescription  String?

  // Pricing
  price             Float
  compareAtPrice    Float?
  costPrice         Float?

  // Inventory
  sku               String?
  stock             Int      @default(0)
  lowStockThreshold Int      @default(5)
  trackInventory    Boolean  @default(true)

  // Type
  type              String   @default("PHYSICAL") // PHYSICAL, DIGITAL, SERVICE
  digitalFileUrl    String?

  // Status
  isActive          Boolean  @default(true)
  isFeatured        Boolean  @default(false)
  order             Int      @default(0)

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  images            ProductImage[]
  variants          ProductVariant[]
  cartItems         CartItem[]
  orderItems        OrderItem[]
  wishlistItems     WishlistItem[]

  @@unique([tenantId, slug])
  @@index([tenantId])
  @@index([categoryId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([tenantId, isActive, isFeatured])
  @@map("products")
}

// ============ PRODUCT IMAGES ============

model ProductImage {
  id        String   @id @default(uuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  alt       String?
  order     Int      @default(0)
  isPrimary Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([productId])
  @@map("product_images")
}

// ============ PRODUCT VARIANTS ============

model ProductVariant {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  name       String   // e.g., "Size", "Color"
  value      String   // e.g., "Large", "Red"
  sku        String?
  price      Float?   // Override product price
  stock      Int      @default(0)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@map("product_variants")
}

// ============ CARTS ============

model Cart {
  id         String   @id @default(uuid())
  tenantId   String
  tenant     Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  sessionId  String?  // For guest carts
  customerId String?  // For logged-in customers
  customer   Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)
  couponId   String?
  coupon     Coupon?  @relation(fields: [couponId], references: [id], onDelete: SetNull)
  expiresAt  DateTime?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  items      CartItem[]

  @@unique([tenantId, sessionId])
  @@index([tenantId])
  @@index([customerId])
  @@index([sessionId])
  @@map("carts")
}

// ============ CART ITEMS ============

model CartItem {
  id         String   @id @default(uuid())
  cartId     String
  cart       Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId  String?
  variant    ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)
  quantity   Int      @default(1)
  price      Float    // Price at time of adding
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([cartId, productId, variantId])
  @@index([cartId])
  @@index([productId])
  @@map("cart_items")
}

// ============ ORDERS ============

model Order {
  id               String   @id @default(uuid())
  tenantId         String
  tenant           Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  orderNumber      String   // User-facing order number
  customerId       String?
  customer         Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  // Customer Snapshot (in case customer deleted)
  customerEmail    String
  customerPhone    String?
  customerName     String

  // Status
  status           String   @default("PENDING") // PENDING, CONFIRMED, PROCESSING, SHIPPED, DELIVERED, CANCELLED

  // Totals
  subtotal         Float
  shippingCost     Float    @default(0)
  discount         Float    @default(0)
  tax              Float    @default(0)
  total            Float

  // Addresses (JSON strings for SQLite compatibility)
  shippingAddress  String?
  billingAddress   String?

  // Coupon
  couponId         String?
  couponCode       String?

  // Notes
  notes            String?
  internalNotes    String?

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  items            OrderItem[]
  statusHistory    OrderStatusHistory[]
  payments         Payment[]

  @@unique([tenantId, orderNumber])
  @@index([tenantId])
  @@index([customerId])
  @@index([status])
  @@index([tenantId, status])
  @@index([tenantId, createdAt])
  @@map("orders")
}

// ============ ORDER ITEMS ============

model OrderItem {
  id              String   @id @default(uuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId       String?
  product         Product? @relation(fields: [productId], references: [id], onDelete: SetNull)
  variantId       String?
  variant         ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  // Snapshot (in case product deleted)
  productName     String
  variantName     String?
  sku             String?

  quantity        Int
  unitPrice       Float
  totalPrice      Float

  // For digital products
  downloadUrl     String?
  downloadCount   Int      @default(0)
  maxDownloads    Int      @default(5)

  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

// ============ ORDER STATUS HISTORY ============

model OrderStatusHistory {
  id          String   @id @default(uuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  status      String
  note        String?
  createdBy   String?  // User ID who changed status
  createdAt   DateTime @default(now())

  @@index([orderId])
  @@map("order_status_history")
}

// ============ PAYMENTS ============

model Payment {
  id                 String    @id @default(uuid())
  orderId            String
  order              Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)

  // Mercado Pago fields
  mercadoPagoId      String?   @unique
  externalReference  String?
  preferenceId       String?

  // Payment info
  amount             Float
  currency           String    @default("ARS")
  status             String    @default("PENDING") // PENDING, APPROVED, REJECTED, CANCELLED, REFUNDED
  paymentMethod      String?
  paymentType        String?

  // Payer info
  payerEmail         String?
  payerName          String?

  // Dates
  paidAt             DateTime?
  refundedAt         DateTime?

  // Raw response
  rawResponse        String?   // JSON string

  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  @@index([orderId])
  @@index([mercadoPagoId])
  @@index([status])
  @@map("payments")
}

// ============ COUPONS ============

model Coupon {
  id               String    @id @default(uuid())
  tenantId         String
  tenant           Tenant    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  code             String
  description      String?

  // Discount type
  discountType     String    @default("PERCENTAGE") // PERCENTAGE, FIXED
  discountValue    Float

  // Limits
  minPurchase      Float?
  maxDiscount      Float?
  usageLimit       Int?      // Total uses allowed
  usageCount       Int       @default(0)
  usagePerCustomer Int       @default(1)

  // Validity
  startsAt         DateTime?
  expiresAt        DateTime?
  isActive         Boolean   @default(true)

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  carts            Cart[]
  usages           CouponUsage[]

  @@unique([tenantId, code])
  @@index([tenantId])
  @@index([code])
  @@index([isActive])
  @@map("coupons")
}

// ============ COUPON USAGE ============

model CouponUsage {
  id         String   @id @default(uuid())
  couponId   String
  coupon     Coupon   @relation(fields: [couponId], references: [id], onDelete: Cascade)
  customerId String?
  orderId    String?
  usedAt     DateTime @default(now())

  @@index([couponId])
  @@index([customerId])
  @@map("coupon_usages")
}

// ============ WISHLIST ============

model WishlistItem {
  id         String   @id @default(uuid())
  tenantId   String
  customerId String
  customer   Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())

  @@unique([customerId, productId])
  @@index([tenantId])
  @@index([customerId])
  @@map("wishlist_items")
}

// ===========================================
// SECURITY MODELS
// ===========================================

// ============ TOTP (2FA) ============

model TotpSecret {
  id           String    @id @default(uuid())
  userId       String    @unique
  user         User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Encrypted secret
  secret       String    // AES-256-GCM encrypted
  iv           String    // Initialization vector

  // Backup codes (hashed)
  backupCodes  String?   // JSON array of hashed codes

  // Status
  isEnabled    Boolean   @default(false)
  isVerified   Boolean   @default(false)

  // Timestamps
  enabledAt    DateTime?
  lastUsedAt   DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@map("totp_secrets")
}

// ============ MERCADO PAGO CREDENTIALS ============

model MercadoPagoCredential {
  id             String   @id @default(uuid())
  tenantId       String   @unique
  tenant         Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  // Encrypted credentials
  publicKey      String   // AES-256-GCM encrypted
  accessToken    String   // AES-256-GCM encrypted
  iv             String   // Initialization vector

  // Mode
  isSandbox      Boolean  @default(true)

  // Webhook
  webhookSecret  String?

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("mercadopago_credentials")
}
